Based on
https://stackoverflow.com/questions/54980799/a-complete-example-for-a-webrtc-datachannel-with-manual-signaling
<p id="stat"></p>
<button id="button" onclick="createOffer()">Offer:</button>
<br />
Chat: <input id="chat" /><br />
<div id="output">Chat:</div>
<script>
  const chat = document.getElementById("chat");
  const output = document.getElementById("output");
  const config = {
    iceServers: [
      {
        urls: "stun:stun.1.google.com:19302",
      },
    ],
  };
  const pc = new RTCPeerConnection(config);
  const dc = pc.createDataChannel("chat", {
    negotiated: true,
    id: 0,
  });
  // const log = msg => output.innerHTML += `<br>${msg}`;
  // append textarea for every message
  const log = (msg) => {
    let textarea = document.createElement("textarea");
    // make it full with and 3 rows
    textarea.style = "width:100%;height:3em";
    textarea.value = msg;
    output.appendChild(textarea);
    // output.appendChild(document.createElement('br'));
  };
  dc.onopen = () => chat.select();
  dc.onmessage = (e) => log(`${e.data}`);
  pc.oniceconnectionstatechange = (e) => log(pc.iceConnectionState);
  pc.onsignalingstatechange = () => {
        console.log(`onsignalingstatechange: signalingState: ${pc.signalingState}`);
      };
  chat.onkeypress = async function (e) {
    if (e.keyCode != 13) return;
    // if got message and state is new, means message is offer from other node
    if (pc.connectionState == "new") {
      let offer = JSON.parse(chat.value);
      chat.value = "";

      console.log(`[pc.connectionState == "new"] prior to setRemoteDescription() signalingState: ${pc.signalingState}`);
      await pc.setRemoteDescription(offer);
      console.log(`[pc.connectionState == "new"] prior to setLocalDescription() signalingState: ${pc.signalingState}`);
      await pc.setLocalDescription(await pc.createAnswer());
      console.log(`setLocalDescription`);
      pc.onicecandidate = ({ candidate }) => {
        console.log(`[pc.connectionState == "new"] onicecandidate() signalingState: ${pc.signalingState} candidate: ${candidate}`);
        if (candidate) return;
        const answer = pc.localDescription;
        log(JSON.stringify(answer));
      };
      return;
    } else if (pc.connectionState == "connecting") {
      const answer = JSON.parse(chat.value);
      chat.value = "";
      console.log(`[pc.connectionState == "connecting"] prior to setRemoteDescription() signalingState: ${pc.signalingState}`);
      // pc.setRemoteDescription(answer);
      await pc.setRemoteDescription(new RTCSessionDescription(answer));
      console.log(`[pc.connectionState == "connecting"] prior to createAnswer() signalingState: ${pc.signalingState}`);
      // await pc.createAnswer().then(answer => pc.setLocalDescription(answer));
      return
    }
    dc.send(chat.value);
    log(chat.value);
    chat.value = "";
  };

  async function createOffer() {
    button.disabled = true;
    await pc.setLocalDescription(await pc.createOffer());
    pc.onicecandidate = ({ candidate }) => {
      console.log(`[createOffer()] onicecandidate() signalingState: ${pc.signalingState} candidate: ${candidate}`);
      if (candidate) return;
      log(JSON.stringify(pc.localDescription));
    };
  }

  pc.onconnectionstatechange = (ev) => handleChange();
  pc.oniceconnectionstatechange = (ev) => handleChange();

  function handleChange() {
    let stat =
      "ConnectionState: <strong>" +
      pc.connectionState +
      "</strong> IceConnectionState: <strong>" +
      pc.iceConnectionState +
      "</strong>";
    document.getElementById("stat").innerHTML = stat;
    let msg =
      "%c" +
      new Date().toISOString() +
      ": ConnectionState: %c" +
      pc.connectionState +
      " %cIceConnectionState: %c" +
      pc.iceConnectionState;
    let colors = ["color:yellow", "color:orange", "color:yellow", "color:orange"];
    // add signalingState
    msg += " %csignalingState: %c" + pc.signalingState;
    colors.push("color:yellow", "color:orange");
    console.log(msg, ...colors);
  }
  handleChange();
</script>
